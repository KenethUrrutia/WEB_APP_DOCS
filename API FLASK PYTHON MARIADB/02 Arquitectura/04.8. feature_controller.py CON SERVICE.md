## 8. Controller (`feature_controller.py`)  
**Propósito**: Maneja las solicitudes HTTP, orquesta llamadas al Service Layer y formatea respuestas API.  

**Ubicación**:  
```
src/features/feature/feature_controller.py  
```

### Estructura Base con Service Layer
```python
from flask_restx import Resource
from flask import request
from src.common.utils import api, ErrorResponseModel
from src.features.feature.feature_schema import FeatureSchema
from src.features.feature.services.feature_service import FeatureService
from src.features.feature.feature_doc import (
    FeatureCreateDoc,
    FeatureResponseDoc,
    FeatureUpdateDoc
)
from sqlalchemy.exc import IntegrityError, DataError
from marshmallow import ValidationError
import logging

logger = logging.getLogger(__name__)

class FeatureController(Resource):
    @api.doc(description='Obtiene todos los recursos')
    @api.response(200, 'Éxito', [FeatureResponseDoc])
    @api.response(500, 'Error interno', ErrorResponseModel)
    def get(self):
        """Lista todos los recursos usando Service Layer"""
        try:
            features = FeatureService.get_all()
            return FeatureSchema(many=True).dump(features), 200
        except Exception as e:
            logger.error(f"Error en GET /features: {str(e)}")
            return {"error": "Error al obtener recursos"}, 500

    @api.doc(description='Crea un nuevo recurso')
    @api.expect(FeatureCreateDoc)
    @api.response(201, 'Creado', FeatureResponseDoc)
    @api.response(400, 'Datos inválidos', ErrorResponseModel)
    @api.response(422, 'Validación fallida', ErrorResponseModel)
    def post(self):
        """Crea un recurso mediante Service Layer"""
        try:
            feature = FeatureService.create(request.json)
            return FeatureSchema().dump(feature), 201
        except ValidationError as e:
            return {
                "error": "Error de validación",
                "details": e.messages
            }, 422
        except IntegrityError:
            return {"error": "Conflicto de datos (duplicado)"}, 409
        except Exception as e:
            logger.critical(f"Error en POST /features: {str(e)}")
            return {"error": "Error al crear recurso"}, 500
```

### Controller para Operaciones por ID
```python
class FeatureControllerById(Resource):
    @api.doc(description='Obtiene un recurso por ID')
    @api.param('id', 'ID del recurso', _in='path')
    @api.response(200, 'Éxito', FeatureResponseDoc)
    @api.response(404, 'No encontrado', ErrorResponseModel)
    def get(self, id):
        """Obtiene un recurso específico"""
        try:
            feature = FeatureService.get_by_id(id)
            if not feature:
                return {"error": "Recurso no encontrado"}, 404
            return FeatureSchema().dump(feature), 200
        except Exception as e:
            logger.error(f"Error en GET /features/{id}: {str(e)}")
            return {"error": "Error al obtener recurso"}, 500

    @api.doc(description='Actualiza un recurso completo')
    @api.expect(FeatureUpdateDoc)
    @api.response(200, 'Actualizado', FeatureResponseDoc)
    @api.response(404, 'No encontrado', ErrorResponseModel)
    def put(self, id):
        """Actualización mediante Service Layer"""
        try:
            data = request.json
            data["id"] = id  # Asegura el ID del path
            feature = FeatureService.update(data)
            if not feature:
                return {"error": "Recurso no encontrado"}, 404
            return FeatureSchema().dump(feature), 200
        except ValidationError as e:
            return {"error": e.messages}, 422
        except Exception as e:
            logger.error(f"Error en PUT /features/{id}: {str(e)}")
            return {"error": "Error al actualizar"}, 500

    @api.doc(description='Elimina un recurso')
    @api.response(204, 'Eliminado')
    @api.response(404, 'No encontrado', ErrorResponseModel)
    def delete(self, id):
        """Eliminación mediante Service Layer"""
        try:
            success = FeatureService.delete(id)
            if not success:
                return {"error": "Recurso no encontrado"}, 404
            return '', 204
        except Exception as e:
            logger.error(f"Error en DELETE /features/{id}: {str(e)}")
            return {"error": "Error al eliminar"}, 500
```

### Patrones Clave con Service Layer

| Escenario | Implementación | Beneficio |
|-----------|----------------|-----------|
| **Validaciones** | Delegadas al Service Layer | Controllers más limpios |
| **Transformación de Datos** | Manejada en Schemas | Separación de preocupaciones |
| **Gestión de Errores** | Centralizada en Service | Consistencia API |

### Diagrama de Flujo
```mermaid
sequenceDiagram
    Client->>+Controller: HTTP Request
    Controller->>+Service: Llama método
    Service->>+Repository: Ejecuta operación
    Repository-->>-Service: Model/None
    Service-->>-Controller: Datos/Error
    Controller->>Client: HTTP Response
```

### Ejemplo de Respuestas Estándar

| Código | Método         | Body de Ejemplo                                     |
| ------ | -------------- | --------------------------------------------------- |
| 200    | GET            | `{id: "123", name: "Feature 1"}`                    |
| 201    | POST           | `{id: "456", name: "New Feature"}`                  |
| 204    | DELETE         | Vacío                                               |
| 404    | GET/PUT/DELETE | `{"error": "No encontrado"}`                        |
| 422    | POST/PUT       | `{"error": "Validación fallida", "details": {...}}` |

### Documentación Oficial
- [Flask-RESTx](https://flask-restx.readthedocs.io/en/latest/)
- [HTTP Status Codes](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)
- [Logging Best Practices](https://docs.python.org/3/howto/logging.html)

